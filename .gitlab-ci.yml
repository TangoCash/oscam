stages:
  - tag

tag-job:
  stage: tag
  tags:
    - versioning
  only:
   - master
  script:
    - echo "Tagging + Versioning automation process..."
    - git status
    - git branch -l --all
    - git describe --tags --abbrev=0 2>/dev/null
    - git rev-parse HEAD
    - ./config.sh --oscam-revision
    - ./config.sh --oscam-commit

    - git config user.name "pipeline-user"
    - git config user.email "pipeline-user@users.noreply.git.streamboard.tv"

    - curr_tag=$(git describe --tags --abbrev=0 2>/dev/null)
    - new_tag=$(( $curr_tag + 10 ))

    - echo "Updating version information in globals.h..."
    - sed -i "/# define CS_SVN_VERSION/s/.*/# define CS_SVN_VERSION\t\t\t\"$new_tag\"/" ./globals.h
    - git diff globals.h
    - git add globals.h
    - git commit --amend --no-edit

    - sha=$(git rev-parse HEAD)

    - echo "Removing existing tag:$new_tag..."
    - if git tag --list | grep -iq "$new_tag"; then
        git tag --delete "$new_tag";
        git push "http://version-pipeline:${GIT_PUSH_TOKEN}@${CI_REPOSITORY_URL#*@}" --delete "$new_tag" -o ci.skip;
      fi;

    - echo "Creating new tag:$new_tag on sha:$sha..."
    - git tag --annotate "$new_tag" -m "Revision $new_tag" "$sha"

    - git push --force --follow-tags "http://pipeline-user:${GIT_PUSH_TOKEN}@${CI_REPOSITORY_URL#*@}" HEAD:$CI_COMMIT_BRANCH -o ci.skip
    - echo "Tagging + Versioning automation complete."
